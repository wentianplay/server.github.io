<?php$nick=trim($_GET['n']);if(!$nick) die('LoginFail('.@$_GET['s'].',"昵称不能为空");');$plogin=0;$dxcl='false';if(isset($_SESSION['id'])){	$s=$db->prepare('select status from oluser where id=? and nick=? and ip=INET_ATON(?) limit 1');	$s->execute(array($_SESSION['id'],$nick,$_SERVER['REMOTE_ADDR']));	$si=$s->fetch();	if($si===FALSE)	{		$_SESSION=array();	}	else	{		if($si[0]>=4)		{			$plogin=2;			$dxcl='true';		}		else		{			$s=$db->prepare('update oluser set room=0 where id=? limit 1');			$s->execute(array($_SESSION['id']));			$plogin=1;		}		$uid=$_SESSION['id'];		$_SESSION=array();		$_SESSION['id']=$uid;	}}if($plogin==0){	$checktime=time()-30;	$s=$db->prepare('delete from oluser where lasttime<? and status<4');	$s->execute(array($checktime));	$s=$db->query('select count(*) from oluser');	$si=$s->fetchColumn();	if($si>=$cfg_maxuser) die('LoginFail('.@$_GET['s'].',"服务器已满！");');	if($cfg_limitip)	{		$s=$db->prepare('select count(*) from oluser where ip=INET_ATON(?)');		$s->execute(array($_SERVER['REMOTE_ADDR']));		$si=$s->fetchColumn();		if($si>=$cfg_perip) die('LoginFail('.@$_GET['s'].',"您所在的IP连接用户数已达上限");');	}	$s=$db->prepare('insert into oluser (nick,lasttime,ip) values (?,?,INET_ATON(?))');	$s->execute(array($nick,time(),$_SERVER['REMOTE_ADDR']));	$uid=$_SESSION['id']=$db->lastInsertId();}$s=$db->exec('delete from rooms where not exists (select * from oluser where room=rooms.id and status<>3 and status<>5 limit 1)');$s=$db->query('select *,(select count(*) from oluser where room=a.id and status<>3) as renshu,(select nick from oluser where id=a.fangzhu) as fzname from rooms a');$si=$s->fetchAll();$roomlist=json_encode($si);$_SESSION['frontid']=$_SESSION['lastid']=$_GET['l'];msend('LoginSuccess('.$roomlist.','.$dxcl.')');?>